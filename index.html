<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Astral con Coincidencias</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .controls-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .coincidencias-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .wheel-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
        }
        .chart-svg {
            width: 100%;
            height: 100%;
        }
        .planet-symbol {
            font-weight: bold;
            cursor: pointer;
        }
        .aspect-line {
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        .year-container {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .year-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .year-content {
            padding: 15px;
            display: none;
        }
        .expanded {
            display: block;
        }
        .coincidence-date {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .coincidence-date:hover {
            background-color: #e9e9e9;
        }
        .planet-btn {
            margin-right: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
        }
        .tooltip-custom {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
        }
        .tab-content {
            padding: 15px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-coincidence {
            margin: 2px;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .planet-list-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .planet-list-item:hover {
            background-color: #f0f0f0;
        }
        .planet-list-item.selected {
            background-color: #e3f2fd;
        }
        .aspect-list-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .aspect-list-item:hover {
            background-color: #f0f0f0;
        }
        .aspect-list-item.selected {
            background-color: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Carta Astral con Coincidencias</h1>
        
        <div class="loading" id="loadingIndicator">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Formulario de entrada -->
        <div class="controls-container mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="city" class="form-label">Ciudad de Nacimiento</label>
                        <input type="text" class="form-control" id="city" placeholder="Ej: Madrid, España" list="cityList">
                        <datalist id="cityList"></datalist>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="date" class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="date">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="time" class="form-label">Hora de Nacimiento</label>
                        <input type="time" class="form-control" id="time">
                    </div>
                </div>
            </div>

            <!-- Formulario de tránsitos -->
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showTransits" checked>
                        <label class="form-check-label" for="showTransits">Mostrar Tránsitos</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="calculateCoincidences">
                        <label class="form-check-label" for="calculateCoincidences">Calcular Coincidencias</label>
                    </div>
                </div>
            </div>

            <div id="transitsContainer">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="transitCity" class="form-label">Ciudad de Tránsito</label>
                            <input type="text" class="form-control" id="transitCity" placeholder="Ej: Madrid, España" list="transitCityList">
                            <datalist id="transitCityList"></datalist>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="transitDate" class="form-label">Fecha de Tránsito</label>
                            <input type="date" class="form-control" id="transitDate">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="transitTime" class="form-label">Hora de Tránsito</label>
                            <input type="time" class="form-control" id="transitTime">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opciones de coincidencias -->
            <div id="coincidencesOptions" style="display: none;">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="startYear" class="form-label">Año inicial</label>
                            <input type="number" class="form-control" id="startYear" min="1900" max="2100">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="endYear" class="form-label">Año final</label>
                            <input type="number" class="form-control" id="endYear" min="1900" max="2100">
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button class="btn btn-primary" id="calculateBtn">Calcular Carta Astral</button>
            </div>

            <div class="alert alert-danger mt-3 d-none" id="errorAlert" role="alert"></div>
            <div class="alert alert-info mt-3 d-none" id="infoBox">
                <span id="ascendenteInfo"></span><br>
                <span id="birthTypeInfo"></span>
            </div>
        </div>
        
        <div class="row" id="chartContent" style="display: none;">
            <!-- Rueda Zodiacal -->
            <div class="col-md-8">
                <div class="chart-container">
                    <div class="wheel-container">
                        <svg id="chartSvg" class="chart-svg" viewBox="0 0 600 600"></svg>
                        <div id="chartTooltip" class="tooltip-custom" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Información y Coincidencias -->
            <div class="col-md-4">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="planets-tab" data-bs-toggle="tab" data-bs-target="#planets" type="button" role="tab" aria-controls="planets" aria-selected="true">Planetas</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="aspects-tab" data-bs-toggle="tab" data-bs-target="#aspects" type="button" role="tab" aria-controls="aspects" aria-selected="false">Aspectos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="coincidences-tab" data-bs-toggle="tab" data-bs-target="#coincidences" type="button" role="tab" aria-controls="coincidences" aria-selected="false">Coincidencias</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <!-- Pestaña de Planetas -->
                    <div class="tab-pane fade show active" id="planets" role="tabpanel" aria-labelledby="planets-tab">
                        <h4>Carta Natal</h4>
                        <div id="natalPlanets"></div>
                        
                        <h4 class="mt-4">Tránsitos</h4>
                        <div id="transitPlanets"></div>
                    </div>
                    
                    <!-- Pestaña de Aspectos -->
                    <div class="tab-pane fade" id="aspects" role="tabpanel" aria-labelledby="aspects-tab">
                        <h4>Aspectos Internos</h4>
                        <div id="internalAspects"></div>

                        <h4 class="mt-4">Aspectos entre Cartas</h4>
                        <div id="interChartAspects"></div>
                    </div>
                    
                    <!-- Pestaña de Coincidencias -->
                    <div class="tab-pane fade" id="coincidences" role="tabpanel" aria-labelledby="coincidences-tab">
                        <div id="coincidencesLoading" class="text-center p-3 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Calculando coincidencias...</p>
                        </div>
                        <div id="noCoincidencesMessage" class="text-center p-3">
                            <p>No se han calculado coincidencias.</p>
                            <button id="loadCoincidencesBtn" class="btn btn-primary">Calcular Coincidencias</button>
                        </div>
                        <div id="coincidencesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap y Librerías JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script principal -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Constantes globales
        const DIMENSIONS = {
            centerX: 300,
            centerY: 300,
            radius: 250,
            middleRadius: 180, // Radio para la carta externa (tránsitos)
            innerRadius: 110,  // Radio para la carta interna (natal)
            glyphRadius: 235
        };

        const SIGNS = [
            {name: 'ARIES', start: 354, length: 36, symbol: '♈', color: '#FFE5E5'},
            {name: 'TAURUS', start: 30, length: 30, symbol: '♉', color: '#E5FFE5'},
            {name: 'GEMINI', start: 60, length: 30, symbol: '♊', color: '#FFFFE5'},
            {name: 'CANCER', start: 90, length: 30, symbol: '♋', color: '#E5FFFF'},
            {name: 'LEO', start: 120, length: 30, symbol: '♌', color: '#FFE5E5'},
            {name: 'VIRGO', start: 150, length: 36, symbol: '♍', color: '#E5FFE5'},
            {name: 'LIBRA', start: 186, length: 24, symbol: '♎', color: '#FFFFE5'},
            {name: 'SCORPIO', start: 210, length: 30, symbol: '♏', color: '#E5FFFF'},
            {name: 'OPHIUCHUS', start: 240, length: 12, symbol: '⛎', color: '#FFFFE5'},
            {name: 'SAGITTARIUS', start: 252, length: 18, symbol: '♐', color: '#FFE5E5'},
            {name: 'CAPRICORN', start: 270, length: 36, symbol: '♑', color: '#E5FFE5'},
            {name: 'AQUARIUS', start: 306, length: 18, symbol: '♒', color: '#FFFFE5'},
            {name: 'PEGASUS', start: 324, length: 6, symbol: '∩', color: '#E5FFFF'},
            {name: 'PISCES', start: 330, length: 24, symbol: '♓', color: '#E5FFFF'}
        ];

        const PLANET_SYMBOLS = {
            'SOL': '☉',
            'LUNA': '☽',
            'MERCURIO': '☿',
            'VENUS': '♀',
            'MARTE': '♂',
            'JÚPITER': '♃',
            'SATURNO': '♄',
            'URANO': '♅',
            'NEPTUNO': '♆',
            'PLUTÓN': '♇',
            'ASC': 'ASC',
            'MC': 'MC',
            'DSC': 'DSC',
            'IC': 'IC'
        };

        const ASPECTS = {
            'CONJUNCTION': { angle: 0, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            'SEXTILE': { angle: 60, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            'SQUARE': { angle: 90, orb: 2, color: '#FF0000', name: 'Inarmónico Relevante' },
            'TRINE': { angle: 120, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            'OPPOSITION': { angle: 180, orb: 2, color: '#000080', name: 'Armónico Relevante' }
        };

        const COLORS = {
            RED: '#FF0000',
            GREEN: '#00FF00',
            BLUE: '#0000FF',
            YELLOW: '#FFFF00'
        };

        // Variables globales
        let natalPlanets = [];
        let transitPlanets = [];
        let internalAspects = [];
        let interChartAspects = [];
        let coincidences = [];
        let selectedPlanet = null;
        let selectedAspect = null;
        let isDry = null;
        let ascendenteName = '';
        let birthDate = null;

        // Elementos DOM
        const cityInput = document.getElementById('city');
        const cityList = document.getElementById('cityList');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const transitCityInput = document.getElementById('transitCity');
        const transitCityList = document.getElementById('transitCityList');
        const transitDateInput = document.getElementById('transitDate');
        const transitTimeInput = document.getElementById('transitTime');
        const showTransitsToggle = document.getElementById('showTransits');
        const calculateCoincidencesToggle = document.getElementById('calculateCoincidences');
        const coincidencesOptions = document.getElementById('coincidencesOptions');
        const startYearInput = document.getElementById('startYear');
        const endYearInput = document.getElementById('endYear');
        const transitsContainer = document.getElementById('transitsContainer');
        const calculateBtn = document.getElementById('calculateBtn');
        const chartContent = document.getElementById('chartContent');
        const chartSvg = document.getElementById('chartSvg');
        const natalPlanetsContainer = document.getElementById('natalPlanets');
        const transitPlanetsContainer = document.getElementById('transitPlanets');
        const internalAspectsContainer = document.getElementById('internalAspects');
        const interChartAspectsContainer = document.getElementById('interChartAspects');
        const coincidencesListContainer = document.getElementById('coincidencesList');
        const coincidencesLoading = document.getElementById('coincidencesLoading');
        const noCoincidencesMessage = document.getElementById('noCoincidencesMessage');
        const loadCoincidencesBtn = document.getElementById('loadCoincidencesBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const chartTooltip = document.getElementById('chartTooltip');
        const errorAlert = document.getElementById('errorAlert');
        const infoBox = document.getElementById('infoBox');
        const ascendenteInfo = document.getElementById('ascendenteInfo');
        const birthTypeInfo = document.getElementById('birthTypeInfo');

        // Inicialización
        function init() {
            // Establecer fecha y hora actuales
            const now = new Date();
            dateInput.value = now.toISOString().split('T')[0];
            timeInput.value = now.toTimeString().slice(0, 5);
            
            transitDateInput.value = now.toISOString().split('T')[0];
            transitTimeInput.value = now.toTimeString().slice(0, 5);
            
            // Establecer años por defecto para las coincidencias
            const currentYear = now.getFullYear();
            startYearInput.value = currentYear;
            endYearInput.value = currentYear + 5;
            
            // Event listeners
            cityInput.addEventListener('input', debounce(function() {
                handleCitySearch(cityInput.value, false);
            }, 300));
            
            transitCityInput.addEventListener('input', debounce(function() {
                handleCitySearch(transitCityInput.value, true);
            }, 300));
            
            showTransitsToggle.addEventListener('change', toggleTransits);
            calculateCoincidencesToggle.addEventListener('change', toggleCoincidencesOptions);
            calculateBtn.addEventListener('click', calculateChart);
            loadCoincidencesBtn.addEventListener('click', loadCoincidences);
            
            // Listener para cambio de pestañas
            document.getElementById('coincidences-tab').addEventListener('click', function() {
                checkCoincidencesStatus();
            });
            
            // Ocultar loading
            loadingIndicator.style.display = 'none';
            
            // Inicializar el estado de los tránsitos
            toggleTransits();
            toggleCoincidencesOptions();
        }

        // Función para manejar la búsqueda de ciudades
        function handleCitySearch(searchText, isTransit) {
            const searchQuery = searchText.trim();
            const resultsContainer = isTransit ? transitCityList : cityList;
            
            if (searchQuery.length < 3) {
                resultsContainer.innerHTML = '';
                return;
            }
            
            // Llamada a la API para buscar ciudades
            fetch(`/cities?ciudad=${encodeURIComponent(searchQuery)}`)
                .then(response => response.json())
                .then(data => {
                    // Limpiar datalist
                    resultsContainer.innerHTML = '';
                    
                    // Añadir opciones
                    if (data.ciudades && data.ciudades.length > 0) {
                        data.ciudades.forEach(ciudad => {
                            const option = document.createElement('option');
                            option.value = ciudad.nombre;
                            option.setAttribute('data-lat', ciudad.lat);
                            option.setAttribute('data-lon', ciudad.lon);
                            resultsContainer.appendChild(option);
                        });
                    } else {
                        // Ciudades de ejemplo si no hay resultados
                        const examples = [
                            { nombre: `${searchQuery}, España`, lat: 40.416, lon: -3.703 },
                            { nombre: `${searchQuery}, México`, lat: 19.432, lon: -99.133 },
                            { nombre: `${searchQuery}, Argentina`, lat: -34.603, lon: -58.381 }
                        ];
                        
                        examples.forEach(ciudad => {
                            const option = document.createElement('option');
                            option.value = ciudad.nombre;
                            option.setAttribute('data-lat', ciudad.lat);
                            option.setAttribute('data-lon', ciudad.lon);
                            resultsContainer.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error buscando ciudades:', error);
                });
        }

        // Función para mostrar/ocultar sección de tránsitos
        function toggleTransits() {
            const isChecked = showTransitsToggle.checked;
            
            if (isChecked) {
                transitsContainer.style.opacity = '1';
                transitsContainer.style.pointerEvents = 'auto';
            } else {
                transitsContainer.style.opacity = '0.5';
                transitsContainer.style.pointerEvents = 'none';
            }
        }

        // Función para mostrar/ocultar opciones de coincidencias
        function toggleCoincidencesOptions() {
            const isChecked = calculateCoincidencesToggle.checked;
            coincidencesOptions.style.display = isChecked ? 'block' : 'none';
        }

        // Función para comprobar el estado de las coincidencias
        function checkCoincidencesStatus() {
            if (coincidences.length > 0) {
                // Ya tenemos coincidencias cargadas
                coincidencesLoading.classList.add('d-none');
                noCoincidencesMessage.classList.add('d-none');
                coincidencesListContainer.style.display = 'block';
            } else if (natalPlanets.length > 0) {
                // Tenemos carta pero no coincidencias
                coincidencesLoading.classList.add('d-none');
                noCoincidencesMessage.classList.remove('d-none');
                coincidencesListContainer.style.display = 'none';
            } else {
                // No hay carta calculada todavía
                coincidencesLoading.classList.add('d-none');
                noCoincidencesMessage.classList.remove('d-none');
                coincidencesListContainer.style.display = 'none';
            }
        }

        // Función para calcular la carta astral
        function calculateChart() {
            // Validar entradas
            if (!cityInput.value || !dateInput.value || !timeInput.value) {
                showError("Debes ingresar ciudad, fecha y hora para la carta natal.");
                return;
            }
            
            if (showTransitsToggle.checked && (!transitCityInput.value || !transitDateInput.value || !transitTimeInput.value)) {
                showError("Debes ingresar ciudad, fecha y hora para los tránsitos.");
                return;
            }
            
            // Mostrar loading
            loadingIndicator.style.display = 'flex';
            hideError();
            
            // Guardar fecha de nacimiento para uso posterior
            birthDate = dateInput.value;
            
            // Calcular carta natal
            const natalData = {
                city: cityInput.value,
                date: dateInput.value,
                time: timeInput.value
            };
            
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(natalData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Guardar datos
                natalPlanets = data.positions;
                internalAspects = data.aspects;
                
                // Solo cargar coincidencias si está activada la opción
                if (calculateCoincidencesToggle.checked) {
                    coincidences = data.coincidencias || [];
                } else {
                    coincidences = [];
                }
                
                isDry = data.isDry;
                
                // Mostrar información del ascendente
                const ascPlanet = natalPlanets.find(p => p.name === 'ASC');
                if (ascPlanet) {
                    ascendenteName = ascPlanet.sign;
                    showBirthInfo(ascPlanet.sign, isDry);
                }
                
                // Si hay tránsitos, calcularlos también
                if (showTransitsToggle.checked) {
                    const transitDate = transitDateInput.value;
                    
                    fetch('/calculate_coincidence', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ date: transitDate })
                    })
                    .then(transitResponse => transitResponse.json())
                    .then(transitData => {
                        if (transitData.error) {
                            throw new Error(transitData.error);
                        }
                        
                        transitPlanets = transitData.positions;
                        
                        // Calcular aspectos entre cartas
                        interChartAspects = calculateAspects(natalPlanets, transitPlanets);
                        
                        // Renderizar carta completa
                        renderChart();
                    })
                    .catch(error => {
                        console.error('Error calculando tránsitos:', error);
                        showError("Error calculando tránsitos: " + error.message);
                        loadingIndicator.style.display = 'none';
                    });
                } else {
                    transitPlanets = [];
                    interChartAspects = [];
                    renderChart();
                }
            })
            .catch(error => {
                console.error('Error calculando carta:', error);
                showError("Error calculando carta: " + error.message);
                loadingIndicator.style.display = 'none';
            });
        }

        // Función para cargar coincidencias bajo demanda
        function loadCoincidences() {
            if (!natalPlanets.length) {
                showError("Debes calcular la carta natal primero.");
                return;
            }
            
            // Validar años
            const startYear = parseInt(startYearInput.value);
            const endYear = parseInt(endYearInput.value);
            
            if (isNaN(startYear) || isNaN(endYear) || startYear > endYear) {
                showError("El rango de años no es válido.");
                return;
            }
            
            // Mostrar indicador de carga
            coincidencesLoading.classList.remove('d-none');
            noCoincidencesMessage.classList.add('d-none');
            
            // Preparar datos
            const requestData = {
                birthDate: birthDate,
                isDry: isDry,
                ascendente: ascendenteName.toLowerCase(),
                startYear: startYear,
                endYear: endYear
            };
            
            // Llamada a endpoint específico para calcular coincidencias
            fetch('/calculate_coincidences', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Guardar coincidencias
                coincidences = data.coincidencias || [];
                
                // Actualizar UI
                coincidencesLoading.classList.add('d-none');
                noCoincidencesMessage.classList.add('d-none');
                
                // Renderizar coincidencias
                updateCoincidencesList();
                coincidencesListContainer.style.display = 'block';
            })
            .catch(error => {
                console.error('Error calculando coincidencias:', error);
                showError("Error calculando coincidencias: " + error.message);
                
                coincidencesLoading.classList.add('d-none');
                noCoincidencesMessage.classList.remove('d-none');
            });
        }

        // Función para calcular aspectos entre planetas
        function calculateAspects(planets1, planets2) {
            // Filtrar planetas tradicionales
            const traditionalPlanets = ["SOL", "LUNA", "MERCURIO", "VENUS", "MARTE", "JÚPITER", "SATURNO"];
            const validPlanets1 = planets1.filter(p => traditionalPlanets.includes(p.name));
            const validPlanets2 = planets2.filter(p => traditionalPlanets.includes(p.name));
            
            const aspects = [];
            const isSameChart = planets1 === planets2;
            
            for (let i = 0; i < validPlanets1.length; i++) {
                // Si es la misma carta, evitar aspectos duplicados
                const startJ = isSameChart ? i + 1 : 0;
                
                for (let j = startJ; j < validPlanets2.length; j++) {
                    const planet1 = validPlanets1[i];
                    const planet2 = validPlanets2[j];
                    
                    if (planet1 === planet2) continue;
                    
                    let diff = Math.abs(planet1.longitude - planet2.longitude);
                    if (diff > 180) diff = 360 - diff;
                    
                    // Comprobar aspectos importantes
                    for (const aspectType in ASPECTS) {
                        const aspect = ASPECTS[aspectType];
                        
                        if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                            aspects.push({
                                planet1: planet1.name,
                                planet2: planet2.name,
                                type: aspectType,
                                angle: diff,
                                color: aspect.color,
                                isInterChart: !isSameChart
                            });
                            break;
                        }
                    }
                }
            }
            
            return aspects;
        }

        // Función para renderizar la carta astral
        function renderChart() {
            // Limpiar SVG
            chartSvg.innerHTML = '';
            
            // Dibujar elementos
            drawZodiacWheel();
            drawAspects();
            drawPlanets(natalPlanets, true);
            
            if (showTransitsToggle.checked && transitPlanets.length > 0) {
                drawPlanets(transitPlanets, false);
            }
            
            // Actualizar listas de información
            updatePlanetsList();
            updateAspectsList();
            updateCoincidencesList();
            
            // Verificar estado de coincidencias
            checkCoincidencesStatus();
            
            // Mostrar la carta
            chartContent.style.display = 'flex';
            
            // Ocultar loading
            loadingIndicator.style.display = 'none';
        }

        // Función para dibujar la rueda zodiacal
        function drawZodiacWheel() {
            // Dibujar círculo exterior
            const outerCircle = createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.radius,
                fill: 'none',
                stroke: '#333',
                'stroke-width': 2
            });
            chartSvg.appendChild(outerCircle);
            
            // Dibujar signos zodiacales
            SIGNS.forEach(sign => {
                const midAngle = ((sign.start + sign.length/2 - 90) * Math.PI) / 180;
                const glyphX = DIMENSIONS.centerX + DIMENSIONS.glyphRadius * Math.cos(midAngle);
                const glyphY = DIMENSIONS.centerY + DIMENSIONS.glyphRadius * Math.sin(midAngle);
                
                // Dibujar sector
                const path = createSvgElement('path', {
                    d: createArcPath(sign.start, sign.start + sign.length),
                    fill: sign.color,
                    stroke: '#333',
                    'stroke-width': 1
                });
                chartSvg.appendChild(path);
                
                // Añadir símbolo
                const text = createSvgElement('text', {
                    x: glyphX,
                    y: glyphY,
                    'text-anchor': 'middle',
                    'alignment-baseline': 'middle',
                    'font-size': 20
                });
                text.textContent = sign.symbol;
                chartSvg.appendChild(text);
            });
            
            // Dibujar círculo intermedio para tránsitos
            if (showTransitsToggle.checked && transitPlanets.length > 0) {
                const middleCircle = createSvgElement('circle', {
                    cx: DIMENSIONS.centerX,
                    cy: DIMENSIONS.centerY,
                    r: DIMENSIONS.middleRadius,
                    fill: 'none',
                    stroke: '#333',
                    'stroke-width': 1,
                    'stroke-dasharray': '5,5'
                });
                chartSvg.appendChild(middleCircle);
            }
            
            // Dibujar círculo interior
            const innerCircle = createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.innerRadius,
                fill: 'white',
                stroke: '#333',
                'stroke-width': 1
            });
            chartSvg.appendChild(innerCircle);
        }

        // Función para dibujar aspectos
        function drawAspects() {
            // Dibujar aspectos internos
            internalAspects.forEach((aspect, index) => {
                const planet1 = natalPlanets.find(p => p.name === aspect.planet1);
                const planet2 = natalPlanets.find(p => p.name === aspect.planet2);
                
                if (!planet1 || !planet2) return;
                
                const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                
                const x1 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle1);
                const y1 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle1);
                const x2 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle2);
                const y2 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle2);
                
                const line = createSvgElement('line', {
                    x1: x1,
                    y1: y1,
                    x2: x2,
                    y2: y2,
                    stroke: aspect.color,
                    'stroke-width': selectedAspect === aspect ? '3' : '1',
                    'data-aspect-index': index,
                    'class': 'aspect-line internal-aspect'
                });
                
                line.addEventListener('click', () => {
                    selectAspect(aspect, 'internal');
                });
                
                line.addEventListener('mouseover', (e) => {
                    const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                    showTooltip(e, `${aspect.planet1} ${aspectName} ${aspect.planet2} (${aspect.angle.toFixed(1)}°)`);
                });
                
                line.addEventListener('mouseout', () => {
                    hideTooltip();
                });
                
                chartSvg.appendChild(line);
            });
            
            // Dibujar aspectos entre cartas
            if (showTransitsToggle.checked && transitPlanets.length > 0) {
                interChartAspects.forEach((aspect, index) => {
                    const planet1 = natalPlanets.find(p => p.name === aspect.planet1);
                    const planet2 = transitPlanets.find(p => p.name === aspect.planet2);
                    
                    if (!planet1 || !planet2) return;
                    
                    const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                    const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                    
                    const x1 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle1);
                    const y1 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle1);
                    const x2 = DIMENSIONS.centerX + DIMENSIONS.middleRadius * Math.cos(angle2);
                    const y2 = DIMENSIONS.centerY + DIMENSIONS.middleRadius * Math.sin(angle2);
                    
                    const line = createSvgElement('line', {
                        x1: x1,
                        y1: y1,
                        x2: x2,
                        y2: y2,
                        stroke: aspect.color,
                        'stroke-width': selectedAspect === aspect ? '3' : '1',
                        'stroke-dasharray': '3,3',
                        'data-aspect-index': index,
                        'class': 'aspect-line inter-aspect'
                    });
                    
                    line.addEventListener('click', () => {
                        selectAspect(aspect, 'inter');
                    });
                    
                    line.addEventListener('mouseover', (e) => {
                        const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                        showTooltip(e, `${aspect.planet1} ${aspectName} ${aspect.planet2} (${aspect.angle.toFixed(1)}°)`);
                    });
                    
                    line.addEventListener('mouseout', () => {
                        hideTooltip();
                    });
                    
                    chartSvg.appendChild(line);
                });
            }
        }

        // Función para dibujar planetas
        function drawPlanets(planets, isNatal) {
            planets.forEach(planet => {
                const radius = isNatal ? DIMENSIONS.innerRadius : DIMENSIONS.middleRadius;
                const angle = (planet.longitude - 90) * Math.PI / 180;
                
                // Ajustar para evitar superposiciones
                const adjustment = adjustPlanetPosition(planet, planets);
                const adjustedAngle = ((planet.longitude + adjustment.angleOffset - 90) * Math.PI) / 180;
                
                const x = DIMENSIONS.centerX + radius * Math.cos(adjustedAngle);
                const y = DIMENSIONS.centerY + radius * Math.sin(adjustedAngle);
                
                // Determinar color del planeta
                const planetColor = getPlanetColor(planet.name, planet.longitude);
                
                // Dibujar círculo del planeta
                const circle = createSvgElement('circle', {
                    cx: x,
                    cy: y,
                    r: selectedPlanet && selectedPlanet.name === planet.name && selectedPlanet.isNatal === isNatal ? '6' : '4',
                    fill: planetColor,
                    stroke: '#000',
                    'stroke-width': '1',
                    'data-planet': planet.name,
                    'data-is-natal': isNatal,
                    'class': 'planet-circle'
                });
                
                // Dibujar símbolo del planeta
                const labelRadius = isNatal ? radius - 20 : radius + 20;
                const labelX = DIMENSIONS.centerX + labelRadius * Math.cos(adjustedAngle);
                const labelY = DIMENSIONS.centerY + labelRadius * Math.sin(adjustedAngle);
                
                const text = createSvgElement('text', {
                    x: labelX,
                    y: labelY,
                    'text-anchor': 'middle',
                    'alignment-baseline': 'middle',
                    'font-size': selectedPlanet && selectedPlanet.name === planet.name && selectedPlanet.isNatal === isNatal ? '18' : '16',
                    'font-weight': 'bold',
                    'data-planet': planet.name,
                    'data-is-natal': isNatal,
                    'class': 'planet-symbol'
                });
                text.textContent = PLANET_SYMBOLS[planet.name] || planet.name;
                
                // Añadir eventos para círculo y símbolo
                [circle, text].forEach(element => {
                    element.addEventListener('click', () => {
                        selectPlanet(planet.name, isNatal);
                    });
                    
                    element.addEventListener('mouseover', (e) => {
                        showTooltip(e, `${planet.name}: ${planet.longitude.toFixed(1)}° ${planet.sign}`);
                    });
                    
                    element.addEventListener('mouseout', () => {
                        hideTooltip();
                    });
                });
                
                chartSvg.appendChild(circle);
                chartSvg.appendChild(text);
            });
        }

        // Función para actualizar la lista de planetas
        function updatePlanetsList() {
            // Actualizar lista de planetas natales
            natalPlanetsContainer.innerHTML = '';
            natalPlanets.forEach(planet => {
                const div = document.createElement('div');
                div.className = 'planet-list-item';
                div.classList.toggle('selected', selectedPlanet && selectedPlanet.name === planet.name && selectedPlanet.isNatal);
                div.innerHTML = `
                    <span style="color: ${getPlanetColor(planet.name, planet.longitude)}">${PLANET_SYMBOLS[planet.name]}</span>
                    ${planet.name}: ${planet.longitude.toFixed(1)}° ${planet.sign}
                `;
                
                div.addEventListener('click', () => {
                    selectPlanet(planet.name, true);
                });
                
                natalPlanetsContainer.appendChild(div);
            });
            
            // Actualizar lista de planetas en tránsito
            transitPlanetsContainer.innerHTML = '';
            if (showTransitsToggle.checked && transitPlanets.length > 0) {
                transitPlanets.forEach(planet => {
                    const div = document.createElement('div');
                    div.className = 'planet-list-item';
                    div.classList.toggle('selected', selectedPlanet && selectedPlanet.name === planet.name && !selectedPlanet.isNatal);
                    div.innerHTML = `
                        <span style="color: ${getPlanetColor(planet.name, planet.longitude)}">${PLANET_SYMBOLS[planet.name]}</span>
                        ${planet.name}: ${planet.longitude.toFixed(1)}° ${planet.sign}
                    `;
                    
                    div.addEventListener('click', () => {
                        selectPlanet(planet.name, false);
                    });
                    
                    transitPlanetsContainer.appendChild(div);
                });
            } else {
                transitPlanetsContainer.innerHTML = '<p class="text-muted">No hay datos de tránsitos disponibles</p>';
            }
        }

        // Función para actualizar la lista de aspectos
        function updateAspectsList() {
            // Aspectos internos
            internalAspectsContainer.innerHTML = '';
            internalAspects.forEach(aspect => {
                const div = document.createElement('div');
                div.className = 'aspect-list-item';
                div.classList.toggle('selected', selectedAspect === aspect);
                
                // Determinar símbolo del aspecto
                let aspectSymbol = '☌'; // Conjunción por defecto
                if (aspect.type === 'SEXTILE') aspectSymbol = '⚹';
                if (aspect.type === 'SQUARE') aspectSymbol = '□';
                if (aspect.type === 'TRINE') aspectSymbol = '△';
                if (aspect.type === 'OPPOSITION') aspectSymbol = '☍';
                
                const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                
                div.innerHTML = `
                    <span style="color: ${aspect.color}">${aspectSymbol}</span>
                    ${PLANET_SYMBOLS[aspect.planet1]} ${aspectName} ${PLANET_SYMBOLS[aspect.planet2]} (${aspect.angle.toFixed(1)}°)
                `;
                
                div.addEventListener('click', () => {
                    selectAspect(aspect, 'internal');
                });
                
                internalAspectsContainer.appendChild(div);
            });
            
            if (internalAspects.length === 0) {
                internalAspectsContainer.innerHTML = '<p class="text-muted">No hay aspectos internos disponibles</p>';
            }
            
            // Aspectos entre cartas
            interChartAspectsContainer.innerHTML = '';
            if (showTransitsToggle.checked && interChartAspects.length > 0) {
                interChartAspects.forEach(aspect => {
                    const div = document.createElement('div');
                    div.className = 'aspect-list-item';
                    div.classList.toggle('selected', selectedAspect === aspect);
                    
                    // Determinar símbolo del aspecto
                    let aspectSymbol = '☌'; // Conjunción por defecto
                    if (aspect.type === 'SEXTILE') aspectSymbol = '⚹';
                    if (aspect.type === 'SQUARE') aspectSymbol = '□';
                    if (aspect.type === 'TRINE') aspectSymbol = '△';
                    if (aspect.type === 'OPPOSITION') aspectSymbol = '☍';
                    
                    const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                    
                    div.innerHTML = `
                        <span style="color: ${aspect.color}">${aspectSymbol}</span>
                        <span style="color: blue">${PLANET_SYMBOLS[aspect.planet1]}</span> ${aspectName} 
                        <span style="color: red">${PLANET_SYMBOLS[aspect.planet2]}</span> (${aspect.angle.toFixed(1)}°)
                    `;
                    
                    div.addEventListener('click', () => {
                        selectAspect(aspect, 'inter');
                    });
                    
                    interChartAspectsContainer.appendChild(div);
                });
            } else {
                interChartAspectsContainer.innerHTML = '<p class="text-muted">No hay aspectos entre cartas disponibles</p>';
            }
        }

        // Función para actualizar la lista de coincidencias
        function updateCoincidencesList() {
            coincidencesListContainer.innerHTML = '';
            
            if (!coincidences || coincidences.length === 0) {
                coincidencesListContainer.innerHTML = '<p class="text-muted">No se encontraron coincidencias</p>';
                return;
            }
            
            // Agrupar coincidencias por año
            const yearGroups = {};
            coincidences.forEach(coincidence => {
                const year = coincidence.overlap.year;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(coincidence);
            });
            
            // Crear elementos para cada año
            Object.keys(yearGroups).sort((a, b) => a - b).forEach(year => {
                const coincidencesForYear = yearGroups[year];
                
                // Contenedor para el año
                const yearContainer = document.createElement('div');
                yearContainer.className = 'year-container mb-3';
                
                // Encabezado del año
                const yearHeader = document.createElement('div');
                yearHeader.className = 'year-header';
                yearHeader.innerHTML = `
                    <span>Año ${year} (${coincidencesForYear.length} coincidencias)</span>
                    <span class="toggle-icon">▶</span>
                `;
                
                // Evento para expandir/contraer
                yearHeader.addEventListener('click', () => {
                    const content = yearHeader.nextElementSibling;
                    const icon = yearHeader.querySelector('.toggle-icon');
                    
                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        icon.textContent = '▶';
                    } else {
                        content.classList.add('expanded');
                        icon.textContent = '▼';
                    }
                });
                
                // Contenido del año (inicialmente oculto)
                const yearContent = document.createElement('div');
                yearContent.className = 'year-content';
                
                // Añadir coincidencias
                coincidencesForYear.forEach(coincidence => {
                    const coincidenceItem = document.createElement('div');
                    coincidenceItem.className = 'coincidence-date';
                    
                    // Formatear fechas
                    const startDate = new Date(coincidence.overlap.start);
                    const endDate = new Date(coincidence.overlap.end);
                    const startFormatted = startDate.toLocaleDateString();
                    const endFormatted = endDate.toLocaleDateString();
                    
                    // Calcular duración en días
                    const durationMs = endDate.getTime() - startDate.getTime();
                    const durationDays = Math.round(durationMs / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Crear contenido
                    coincidenceItem.innerHTML = `
                        <div>
                            <strong>${coincidence.planeta} en ${coincidence.signo}</strong><br>
                            ${startFormatted} - ${endFormatted} (${durationDays} día${durationDays !== 1 ? 's' : ''})
                        </div>
                        <button class="btn btn-sm btn-success use-transit-btn">
                            Ver Tránsitos
                        </button>
                    `;
                    
                    // Evento para usar como tránsito
                    const transitBtn = coincidenceItem.querySelector('.use-transit-btn');
                    transitBtn.addEventListener('click', () => {
                        useCoincidenceAsTransit(coincidence);
                    });
                    
                    yearContent.appendChild(coincidenceItem);
                });
                
                yearContainer.appendChild(yearHeader);
                yearContainer.appendChild(yearContent);
                coincidencesListContainer.appendChild(yearContainer);
            });
        }

        // Función para usar una coincidencia como tránsito
        function useCoincidenceAsTransit(coincidence) {
            // Activar tránsitos
            showTransitsToggle.checked = true;
            toggleTransits();
            
            // Establecer fecha de tránsito
            transitDateInput.value = coincidence.overlap.start;
            
            // Si no hay ciudad de tránsito, usar la de la carta natal
            if (!transitCityInput.value) {
                transitCityInput.value = cityInput.value;
            }
            
            // Mostrar loading
            loadingIndicator.style.display = 'flex';
            
            // Cargar tránsitos para esta fecha
            fetch('/calculate_coincidence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date: coincidence.overlap.start })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Actualizar planetas de tránsito
                transitPlanets = data.positions;
                
                // Calcular aspectos entre cartas
                interChartAspects = calculateAspects(natalPlanets, transitPlanets);
                
                // Renderizar carta
                renderChart();
            })
            .catch(error => {
                console.error('Error cargando tránsitos:', error);
                showError("Error cargando tránsitos: " + error.message);
                loadingIndicator.style.display = 'none';
            });
        }

        // Funciones de selección
        function selectPlanet(planetName, isNatal) {
            // Si ya está seleccionado, deseleccionar
            if (selectedPlanet && selectedPlanet.name === planetName && selectedPlanet.isNatal === isNatal) {
                selectedPlanet = null;
            } else {
                selectedPlanet = { name: planetName, isNatal };
                selectedAspect = null;
            }
            
            // Actualizar visualización
            renderChart();
        }

        function selectAspect(aspect, type) {
            // Si ya está seleccionado, deseleccionar
            if (selectedAspect === aspect) {
                selectedAspect = null;
            } else {
                selectedAspect = aspect;
                selectedPlanet = null;
            }
            
            // Actualizar visualización
            renderChart();
        }

        // Funciones para tooltip
        function showTooltip(event, text) {
            chartTooltip.textContent = text;
            chartTooltip.style.display = 'block';
            
            // Posicionar tooltip
            const rect = chartSvg.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            chartTooltip.style.left = (x + 10) + 'px';
            chartTooltip.style.top = (y + 10) + 'px';
        }

        function hideTooltip() {
            chartTooltip.style.display = 'none';
        }

        // Funciones para mostrar/ocultar mensajes
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.classList.remove('d-none');
        }

        function hideError() {
            errorAlert.classList.add('d-none');
        }

        function showBirthInfo(ascendente, isDry) {
            ascendenteInfo.textContent = `Ascendente: ${ascendente}`;
            birthTypeInfo.textContent = `Tipo de nacimiento: ${isDry ? 'Seco' : 'Húmedo'}`;
            infoBox.classList.remove('d-none');
        }

        // Utilidades
        function createSvgElement(tag, attributes = {}) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
            
            for (const [attr, value] of Object.entries(attributes)) {
                element.setAttribute(attr, value);
            }
            
            return element;
        }

        function createArcPath(startAngle, endAngle) {
            const start = ((startAngle - 90) * Math.PI) / 180;
            const end = ((endAngle - 90) * Math.PI) / 180;
            
            const x1 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(start);
            const y1 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(start);
            const x2 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(end);
            const y2 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(end);
            
            const x1Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(start);
            const y1Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(start);
            const x2Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(end);
            const y2Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(end);
            
            const largeArcFlag = end - start <= Math.PI ? "0" : "1";
            
            return `M ${x1} ${y1} A ${DIMENSIONS.radius} ${DIMENSIONS.radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${DIMENSIONS.innerRadius} ${DIMENSIONS.innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
        }

        function adjustPlanetPosition(planet, allPlanets) {
            const angleDiff = 7; // grados
            
            // Buscar planetas cercanos
            const nearbyPlanets = allPlanets.filter(p => {
                if (p.name === planet.name) return false;
                
                let diff = Math.abs(p.longitude - planet.longitude);
                if (diff > 180) diff = 360 - diff;
                
                return diff < angleDiff;
            });
            
            if (nearbyPlanets.length === 0) {
                return { angleOffset: 0 };
            }
            
            const isLower = planet.name < nearbyPlanets[0].name;
            const angleOffset = isLower ? -3 : 3;
            
            return { angleOffset: angleOffset };
        }

        function getPlanetColor(planet, longitude) {
            if (planet === 'ASC' || planet === 'MC' || planet === 'DSC' || planet === 'IC') return '#000000';
            
            if (planet === 'JÚPITER') {
                if ((longitude >= 306.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00)) 
                    return COLORS.BLUE;
                if (longitude > 150.00 && longitude < 306.00) 
                    return COLORS.RED;
            }

            if (planet === 'SATURNO') {
                if ((longitude >= 330.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00))
                    return COLORS.YELLOW;
                if (longitude > 240.00 && longitude <= 252.00) return COLORS.YELLOW;
                if (longitude > 252.00 && longitude <= 330.00) return COLORS.RED;
                if (longitude > 150.00 && longitude <= 240.00) return COLORS.RED;
                return COLORS.YELLOW;
            }

            if (longitude > 150.00 && longitude <= 330.00) {
                switch(planet) {
                    case 'SOL': case 'MERCURIO': case 'URANO': return COLORS.GREEN;
                    case 'VENUS': case 'LUNA': return COLORS.YELLOW;
                    case 'MARTE': case 'PLUTÓN': return COLORS.BLUE;
                    case 'NEPTUNO': return COLORS.RED;
                    default: return '#000000';
                }
            } else {
                switch(planet) {
                    case 'SOL': case 'MARTE': case 'PLUTÓN': return COLORS.RED;
                    case 'VENUS': return COLORS.GREEN;
                    case 'MERCURIO': case 'SATURNO': case 'URANO': return COLORS.YELLOW;
                    case 'LUNA': case 'NEPTUNO': return COLORS.BLUE;
                    default: return '#000000';
                }
            }
        }

        // Función utilitaria para debounce
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
        
        // Inicializar
        init();
    });
    </script>
</body>
</html>
