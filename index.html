<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Astral con Coincidencias</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .chart-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .controls-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .info-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .coincidencias-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        .wheel-container {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
        }
        .chart-svg {
            width: 100%;
            height: 100%;
        }
        .planet-symbol {
            font-weight: bold;
            cursor: pointer;
        }
        .aspect-line {
            cursor: pointer;
        }
        .hidden {
            display: none;
        }
        .year-container {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .year-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .year-content {
            padding: 15px;
            display: none;
        }
        .expanded {
            display: block;
        }
        .coincidence-date {
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
            background-color: #f1f1f1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .coincidence-date:hover {
            background-color: #e9e9e9;
        }
        .planet-btn {
            margin-right: 5px;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: none;
            cursor: pointer;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 1000;
        }
        .tab-content {
            padding: 15px;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn-coincidence {
            margin: 2px;
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .planet-list-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .planet-list-item:hover {
            background-color: #f0f0f0;
        }
        .planet-list-item.selected {
            background-color: #e3f2fd;
        }
        .aspect-list-item {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            cursor: pointer;
        }
        .aspect-list-item:hover {
            background-color: #f0f0f0;
        }
        .aspect-list-item.selected {
            background-color: #e3f2fd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Carta Astral con Coincidencias</h1>
        
        <div class="loading" id="loadingIndicator">
            <div class="loading-spinner"></div>
        </div>
        
        <!-- Formulario de entrada -->
        <div class="controls-container mb-4">
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="city" class="form-label">Ciudad de Nacimiento</label>
                        <input type="text" class="form-control" id="city" placeholder="Ej: Madrid, España" list="cityList">
                        <datalist id="cityList"></datalist>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="date" class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-control" id="date">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="time" class="form-label">Hora de Nacimiento</label>
                        <input type="time" class="form-control" id="time">
                    </div>
                </div>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-primary" id="calculateBtn">Calcular Carta Astral</button>
            </div>
        </div>
        
        <div class="row" id="chartContent" style="display: none;">
            <!-- Rueda Zodiacal -->
            <div class="col-md-8">
                <div class="chart-container">
                    <div class="wheel-container">
                        <svg id="chartSvg" class="chart-svg" viewBox="0 0 600 600"></svg>
                        <div id="tooltip" class="tooltip" style="display: none;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Información y Coincidencias -->
            <div class="col-md-4">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="planets-tab" data-bs-toggle="tab" data-bs-target="#planets" type="button" role="tab" aria-controls="planets" aria-selected="true">Planetas</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="aspects-tab" data-bs-toggle="tab" data-bs-target="#aspects" type="button" role="tab" aria-controls="aspects" aria-selected="false">Aspectos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="coincidences-tab" data-bs-toggle="tab" data-bs-target="#coincidences" type="button" role="tab" aria-controls="coincidences" aria-selected="false">Coincidencias</button>
                    </li>
                </ul>
                <div class="tab-content" id="myTabContent">
                    <!-- Pestaña de Planetas -->
                    <div class="tab-pane fade show active" id="planets" role="tabpanel" aria-labelledby="planets-tab">
                        <h4>Carta Natal</h4>
                        <div id="natalPlanets"></div>
                        
                        <h4 class="mt-4">Tránsitos</h4>
                        <div id="transitPlanets"></div>
                    </div>
                    
                    <!-- Pestaña de Aspectos -->
                    <div class="tab-pane fade" id="aspects" role="tabpanel" aria-labelledby="aspects-tab">
                        <h4>Aspectos</h4>
                        <div id="aspectsList"></div>
                    </div>
                    
                    <!-- Pestaña de Coincidencias -->
                    <div class="tab-pane fade" id="coincidences" role="tabpanel" aria-labelledby="coincidences-tab">
                        <h4>Coincidencias por Año</h4>
                        <div id="coincidencesList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap y Librerías JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script principal -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Constantes globales
        const DIMENSIONS = {
            centerX: 300,
            centerY: 300,
            radius: 250,
            middleRadius: 180, // Radio para la carta externa (tránsitos)
            innerRadius: 110,  // Radio para la carta interna (natal)
            glyphRadius: 235
        };

        const SIGNS = [
            {name: 'ARIES', start: 354, length: 36, symbol: '♈', color: '#FFE5E5'},
            {name: 'TAURUS', start: 30, length: 30, symbol: '♉', color: '#E5FFE5'},
            {name: 'GEMINI', start: 60, length: 30, symbol: '♊', color: '#FFFFE5'},
            {name: 'CANCER', start: 90, length: 30, symbol: '♋', color: '#E5FFFF'},
            {name: 'LEO', start: 120, length: 30, symbol: '♌', color: '#FFE5E5'},
            {name: 'VIRGO', start: 150, length: 36, symbol: '♍', color: '#E5FFE5'},
            {name: 'LIBRA', start: 186, length: 24, symbol: '♎', color: '#FFFFE5'},
            {name: 'SCORPIO', start: 210, length: 30, symbol: '♏', color: '#E5FFFF'},
            {name: 'OPHIUCHUS', start: 240, length: 12, symbol: '⛎', color: '#FFFFE5'},
            {name: 'SAGITTARIUS', start: 252, length: 18, symbol: '♐', color: '#FFE5E5'},
            {name: 'CAPRICORN', start: 270, length: 36, symbol: '♑', color: '#E5FFE5'},
            {name: 'AQUARIUS', start: 306, length: 18, symbol: '♒', color: '#FFFFE5'},
            {name: 'PEGASUS', start: 324, length: 6, symbol: '∩', color: '#E5FFFF'},
            {name: 'PISCES', start: 330, length: 24, symbol: '♓', color: '#E5FFFF'}
        ];

        const PLANET_SYMBOLS = {
            'SOL': '☉',
            'LUNA': '☽',
            'MERCURIO': '☿',
            'VENUS': '♀',
            'MARTE': '♂',
            'JÚPITER': '♃',
            'SATURNO': '♄',
            'URANO': '♅',
            'NEPTUNO': '♆',
            'PLUTÓN': '♇',
            'ASC': 'ASC',
            'MC': 'MC',
            'DSC': 'DSC',
            'IC': 'IC'
        };

        const COLORS = {
            RED: '#FF0000',
            GREEN: '#00FF00',
            BLUE: '#0000FF',
            YELLOW: '#FFFF00'
        };

        // Variables globales
        let natalPlanets = [];
        let transitPlanets = [];
        let aspects = [];
        let coincidences = [];
        let selectedPlanet = null;
        let selectedAspect = null;

        // Elementos del DOM
        const cityInput = document.getElementById('city');
        const cityList = document.getElementById('cityList');
        const dateInput = document.getElementById('date');
        const timeInput = document.getElementById('time');
        const calculateBtn = document.getElementById('calculateBtn');
        const chartContent = document.getElementById('chartContent');
        const chartSvg = document.getElementById('chartSvg');
        const natalPlanetsContainer = document.getElementById('natalPlanets');
        const transitPlanetsContainer = document.getElementById('transitPlanets');
        const aspectsListContainer = document.getElementById('aspectsList');
        const coincidencesListContainer = document.getElementById('coincidencesList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tooltip = document.getElementById('tooltip');

        // Inicialización
        dateInput.valueAsDate = new Date();
        timeInput.value = new Date().toTimeString().substr(0, 5);
        
        // Ocultar indicador de carga
        loadingIndicator.style.display = 'none';

        // Event Listeners
        cityInput.addEventListener('input', debounce(searchCities, 300));
        calculateBtn.addEventListener('click', calculateChart);

        // Funciones principales
        function searchCities() {
            const search = cityInput.value.trim();
            if (search.length < 3) return;
            
            // Llamada a la API para buscar ciudades
            fetch(`/cities?ciudad=${encodeURIComponent(search)}`)
                .then(response => response.json())
                .then(data => {
                    // Limpiar datalist
                    cityList.innerHTML = '';
                    
                    // Añadir opciones
                    if (data.ciudades && data.ciudades.length > 0) {
                        data.ciudades.forEach(ciudad => {
                            const option = document.createElement('option');
                            option.value = ciudad.nombre;
                            option.setAttribute('data-lat', ciudad.lat);
                            option.setAttribute('data-lon', ciudad.lon);
                            cityList.appendChild(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error buscando ciudades:', error);
                });
        }

        function calculateChart() {
            // Validar entradas
            if (!cityInput.value || !dateInput.value || !timeInput.value) {
                alert('Por favor, completa todos los campos');
                return;
            }
            
            // Mostrar indicador de carga
            loadingIndicator.style.display = 'flex';
            
            // Preparar datos para la API
            const data = {
                city: cityInput.value,
                date: dateInput.value,
                time: timeInput.value
            };
            
            // Llamada a la API para calcular la carta astral
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                // Guardar datos
                natalPlanets = data.positions;
                aspects = data.aspects;
                coincidences = data.coincidencias;
                
                // Mostrar la carta
                renderChart();
                
                // Mostrar el contenido
                chartContent.style.display = 'flex';
                
                // Ocultar indicador de carga
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error calculando la carta:', error);
                alert('Ocurrió un error al calcular la carta astral');
                loadingIndicator.style.display = 'none';
            });
        }

        function loadTransitForDate(date) {
            // Mostrar indicador de carga
            loadingIndicator.style.display = 'flex';
            
            // Llamada a la API para obtener posiciones de tránsito
            fetch('/calculate_coincidence', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ date })
            })
            .then(response => response.json())
            .then(data => {
                // Actualizar tránsitos
                transitPlanets = data.positions;
                
                // Actualizar la carta
                updateChart();
                
                // Ocultar indicador de carga
                loadingIndicator.style.display = 'none';
            })
            .catch(error => {
                console.error('Error cargando tránsitos:', error);
                alert('Ocurrió un error al cargar los tránsitos');
                loadingIndicator.style.display = 'none';
            });
        }

        // Funciones de renderizado
        function renderChart() {
            // Limpiar SVG
            chartSvg.innerHTML = '';
            
            // Dibujar elementos del gráfico
            drawZodiacWheel();
            drawAspects();
            drawPlanets(natalPlanets, true);
            
            if (transitPlanets.length > 0) {
                drawPlanets(transitPlanets, false);
            }
            
            // Actualizar listas
            updatePlanetsList();
            updateAspectsList();
            updateCoincidencesList();
        }

        function updateChart() {
            // Limpiar SVG
            chartSvg.innerHTML = '';
            
            // Redibujar todo
            drawZodiacWheel();
            drawAspects();
            drawPlanets(natalPlanets, true);
            
            if (transitPlanets.length > 0) {
                drawPlanets(transitPlanets, false);
            }
            
            // Actualizar listas de planetas
            updatePlanetsList();
        }

        function drawZodiacWheel() {
            // Dibujar círculo exterior
            const outerCircle = createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.radius,
                fill: 'none',
                stroke: '#333',
                'stroke-width': 2
            });
            chartSvg.appendChild(outerCircle);
            
            // Dibujar signos zodiacales
            SIGNS.forEach(sign => {
                const midAngle = ((sign.start + sign.length/2 - 90) * Math.PI) / 180;
                const glyphX = DIMENSIONS.centerX + DIMENSIONS.glyphRadius * Math.cos(midAngle);
                const glyphY = DIMENSIONS.centerY + DIMENSIONS.glyphRadius * Math.sin(midAngle);
                
                // Dibujar sector
                const path = createSvgElement('path', {
                    d: createArcPath(sign.start, sign.start + sign.length),
                    fill: sign.color,
                    stroke: '#333',
                    'stroke-width': 1
                });
                chartSvg.appendChild(path);
                
                // Añadir símbolo
                const text = createSvgElement('text', {
                    x: glyphX,
                    y: glyphY,
                    'text-anchor': 'middle',
                    'alignment-baseline': 'middle',
                    'font-size': 20
                });
                text.textContent = sign.symbol;
                chartSvg.appendChild(text);
            });
            
            // Dibujar círculo intermedio para tránsitos
            if (transitPlanets.length > 0) {
                const middleCircle = createSvgElement('circle', {
                    cx: DIMENSIONS.centerX,
                    cy: DIMENSIONS.centerY,
                    r: DIMENSIONS.middleRadius,
                    fill: 'none',
                    stroke: '#333',
                    'stroke-width': 1,
                    'stroke-dasharray': '5,5'
                });
                chartSvg.appendChild(middleCircle);
            }
            
            // Dibujar círculo interior
            const innerCircle = createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.innerRadius,
                fill: 'white',
                stroke: '#333',
                'stroke-width': 1
            });
            chartSvg.appendChild(innerCircle);
        }

        function drawAspects() {
            // Solo dibujar aspectos entre planetas natales
            if (!natalPlanets || natalPlanets.length === 0) return;
            
            // Filtrar planetas tradicionales
            const traditionalPlanets = ['SOL', 'LUNA', 'MERCURIO', 'VENUS', 'MARTE', 'JÚPITER', 'SATURNO'];
            const validPlanets = natalPlanets.filter(p => traditionalPlanets.includes(p.name));
            
            for (let i = 0; i < validPlanets.length; i++) {
                for (let j = i + 1; j < validPlanets.length; j++) {
                    const planet1 = validPlanets[i];
                    const planet2 = validPlanets[j];
                    
                    // Calcular diferencia angular
                    let diff = Math.abs(planet1.longitude - planet2.longitude);
                    if (diff > 180) diff = 360 - diff;
                    
                    // Verificar aspectos importantes
                    const aspects = [
                        { name: 'CONJUNCTION', angle: 0, orb: 8, color: '#000080' },
                        { name: 'SEXTILE', angle: 60, orb: 6, color: '#000080' },
                        { name: 'SQUARE', angle: 90, orb: 8, color: '#FF0000' },
                        { name: 'TRINE', angle: 120, orb: 8, color: '#000080' },
                        { name: 'OPPOSITION', angle: 180, orb: 8, color: '#000080' }
                    ];
                    
                    for (const aspect of aspects) {
                        if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                            // Dibujar línea de aspecto
                            const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                            const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                            
                            const x1 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle1);
                            const y1 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle1);
                            const x2 = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(angle2);
                            const y2 = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(angle2);
                            
                            const line = createSvgElement('line', {
                                x1: x1,
                                y1: y1,
                                x2: x2,
                                y2: y2,
                                stroke: aspect.color,
                                'stroke-width': 1,
                                'class': 'aspect-line'
                            });
                            
                            // Datos para mostrar en tooltip
                            line.dataset.aspect = `${planet1.name} ${aspect.name} ${planet2.name} (${diff.toFixed(2)}°)`;
                            
                            // Event listener para mostrar tooltip
                            line.addEventListener('mouseover', function(e) {
                                showTooltip(e, this.dataset.aspect);
                            });
                            
                            line.addEventListener('mouseout', function() {
                                hideTooltip();
                            });
                            
                            chartSvg.appendChild(line);
                            break;
                        }
                    }
                }
            }
        }

        function drawPlanets(planets, isNatal) {
            if (!planets || planets.length === 0) return;
            
            planets.forEach(planet => {
                // Calcular posición
                const radius = isNatal ? DIMENSIONS.innerRadius : DIMENSIONS.middleRadius;
                const angle = (planet.longitude - 90) * Math.PI / 180;
                
                // Ajustar para evitar superposiciones
                const adjustment = adjustPlanetPosition(planet, planets, isNatal);
                const adjustedAngle = ((planet.longitude + adjustment.angleOffset - 90) * Math.PI) / 180;
                
                // Coordenadas del planeta
                const x = DIMENSIONS.centerX + radius * Math.cos(adjustedAngle);
                const y = DIMENSIONS.centerY + radius * Math.sin(adjustedAngle);
                
                // Coordenadas para la etiqueta
                const labelRadius = radius + (isNatal ? -20 : 20);
                const labelX = DIMENSIONS.centerX + labelRadius * Math.cos(adjustedAngle);
                const labelY = DIMENSIONS.centerY + labelRadius * Math.sin(adjustedAngle);
                
                // Determinar color del planeta
                const planetColor = getPlanetColor(planet.name, planet.longitude);
                
                // Crear grupo para el planeta
                const planetGroup = createSvgElement('g', {
                    'class': 'planet-group',
                    'data-planet': planet.name,
                    'data-is-natal': isNatal
                });
                
                // Evento de clic
                planetGroup.addEventListener('click', function() {
                    selectPlanet(planet.name, isNatal);
                });
                
                // Eventos para tooltip
                const tooltipText = `${planet.name}: ${planet.longitude.toFixed(2)}° ${planet.sign}`;
                planetGroup.addEventListener('mouseover', function(e) {
                    showTooltip(e, tooltipText);
                });
                
                planetGroup.addEventListener('mouseout', function() {
                    hideTooltip();
                });
                
                // Dibujar círculo del planeta
                const circle = createSvgElement('circle', {
                    cx: x,
                    cy: y,
                    r: 5,
                    fill: planetColor,
                    stroke: '#000',
                    'stroke-width': 1
                });
                planetGroup.appendChild(circle);
                
                // Dibujar símbolo del planeta
                const text = createSvgElement('text', {
                    x: labelX,
                    y: labelY,
                    'text-anchor': 'middle',
                    'alignment-baseline': 'middle',
                    'font-size': 16,
                    'class': 'planet-symbol'
                });
                text.textContent = PLANET_SYMBOLS[planet.name];
                planetGroup.appendChild(text);
                
                chartSvg.appendChild(planetGroup);
            });
        }

        function updatePlanetsList() {
            // Actualizar lista de planetas natales
            natalPlanetsContainer.innerHTML = '';
            
            natalPlanets.forEach(planet => {
                const div = document.createElement('div');
                div.className = 'planet-list-item';
                div.innerHTML = `<span class="planet-symbol">${PLANET_SYMBOLS[planet.name]}</span> ${planet.name}: ${planet.longitude.toFixed(2)}° ${planet.sign}`;
                
                div.addEventListener('click', () => {
                    selectPlanet(planet.name, true);
                });
                
                if (selectedPlanet && selectedPlanet.name === planet.name && selectedPlanet.isNatal) {
                    div.classList.add('selected');
                }
                
                natalPlanetsContainer.appendChild(div);
            });
            
            // Actualizar lista de planetas en tránsito
            transitPlanetsContainer.innerHTML = '';
            
            if (transitPlanets.length > 0) {
                transitPlanets.forEach(planet => {
                    const div = document.createElement('div');
                    div.className = 'planet-list-item';
                    div.innerHTML = `<span class="planet-symbol">${PLANET_SYMBOLS[planet.name]}</span> ${planet.name}: ${planet.longitude.toFixed(2)}° ${planet.sign}`;
                    
                    div.addEventListener('click', () => {
                        selectPlanet(planet.name, false);
                    });
                    
                    if (selectedPlanet && selectedPlanet.name === planet.name && !selectedPlanet.isNatal) {
                        div.classList.add('selected');
                    }
                    
                    transitPlanetsContainer.appendChild(div);
                });
            } else {
                transitPlanetsContainer.innerHTML = '<p>No hay planetas en tránsito cargados</p>';
            }
        }

        function updateAspectsList() {
            aspectsListContainer.innerHTML = '';
            
            // Mostrar aspectos natales
            if (aspects && aspects.length > 0) {
                aspects.forEach(aspect => {
                    const div = document.createElement('div');
                    div.className = 'aspect-list-item';
                    
                    const symbol1 = PLANET_SYMBOLS[aspect.planet1] || aspect.planet1;
                    const symbol2 = PLANET_SYMBOLS[aspect.planet2] || aspect.planet2;
                    
                    let aspectSymbol = '☌'; // conjunción
                    if (aspect.type === 'SEXTILE') aspectSymbol = '⚹';
                    if (aspect.type === 'SQUARE') aspectSymbol = '□';
                    if (aspect.type === 'TRINE') aspectSymbol = '△';
                    if (aspect.type === 'OPPOSITION') aspectSymbol = '☍';
                    
                    div.innerHTML = `${symbol1} ${aspectSymbol} ${symbol2} (${aspect.angle.toFixed(2)}°)`;
                    
                    if (selectedAspect === aspect) {
                        div.classList.add('selected');
                    }
                    
                    div.addEventListener('click', () => {
                        selectAspect(aspect);
                    });
                    
                    aspectsListContainer.appendChild(div);
                });
            } else {
                aspectsListContainer.innerHTML = '<p>No hay aspectos disponibles</p>';
            }
        }

        function updateCoincidencesList() {
            coincidencesListContainer.innerHTML = '';
            
            if (!coincidences || coincidences.length === 0) {
                coincidencesListContainer.innerHTML = '<p>No se encontraron coincidencias</p>';
                return;
            }
            
            // Agrupar coincidencias por año
            const yearGroups = {};
            coincidences.forEach(coincidence => {
                const year = coincidence.overlap.year;
                if (!yearGroups[year]) {
                    yearGroups[year] = [];
                }
                yearGroups[year].push(coincidence);
            });
            
            // Crear elementos para cada año
            Object.keys(yearGroups).sort().forEach(year => {
                const coincidencesForYear = yearGroups[year];
                
                // Contenedor para el año
                const yearContainer = document.createElement('div');
                yearContainer.className = 'year-container';
                
                // Encabezado del año
                const yearHeader = document.createElement('div');
                yearHeader.className = 'year-header';
                yearHeader.innerHTML = `
                    <span>Año ${year} (${coincidencesForYear.length} coincidencias)</span>
                    <span class="toggle-icon">▶</span>
                `;
                
                // Evento para expandir/contraer
                yearHeader.addEventListener('click', () => {
                    const content = yearHeader.nextElementSibling;
                    const icon = yearHeader.querySelector('.toggle-icon');
                    
                    if (content.classList.contains('expanded')) {
                        content.classList.remove('expanded');
                        icon.textContent = '▶';
                    } else {
                        content.classList.add('expanded');
                        icon.textContent = '▼';
                    }
                });
                
                // Contenido del año (inicialmente oculto)
                const yearContent = document.createElement('div');
                yearContent.className = 'year-content';
                
                // Añadir fechas de coincidencia
                coincidencesForYear.forEach(coincidence => {
                    const startDate = new Date(coincidence.overlap.start);
                    const endDate = new Date(coincidence.overlap.end);
                    
                    const formattedStartDate = startDate.toLocaleDateString();
                    const formattedEndDate = endDate.toLocaleDateString();
                    
                    // Calcular duración en días
                    const durationDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    const coincidenceItem = document.createElement('div');
                    coincidenceItem.className = 'coincidence-date';
                    
                    // Información de la coincidencia
                    const infoDiv = document.createElement('div');
                    infoDiv.innerHTML = `
                        <strong>${coincidence.planeta} en ${coincidence.signo}</strong><br>
                        ${formattedStartDate} - ${formattedEndDate} (${durationDays} día${durationDays !== 1 ? 's' : ''})
                    `;
                    
                    // Botones para cada día de la coincidencia
                    const buttonsDiv = document.createElement('div');
                    
                    if (durationDays <= 5) {
                        // Para coincidencias cortas, mostrar un botón por día
                        for (let i = 0; i < durationDays; i++) {
                            const date = new Date(startDate);
                            date.setDate(date.getDate() + i);
                            
                            const formattedDate = date.toISOString().split('T')[0];
                            
                            const button = document.createElement('button');
                            button.className = 'btn btn-sm btn-coincidence';
                            button.style.backgroundColor = getColorForPlanet(coincidence.planeta);
                            button.style.color = 'white';
                            button.textContent = PLANET_SYMBOLS[coincidence.planeta] || (i + 1);
                            button.title = `Ver tránsitos para ${date.toLocaleDateString()}`;
                            
                            button.addEventListener('click', () => {
                                loadTransitForDate(formattedDate);
                            });
                            
                            buttonsDiv.appendChild(button);
                        }
                    } else {
                        // Para coincidencias largas, mostrar solo inicio, medio y fin
                        const startButton = createDateButton(startDate, coincidence.planeta, 'Inicio');
                        
                        const midDate = new Date(startDate);
                        midDate.setDate(midDate.getDate() + Math.floor(durationDays / 2));
                        const midButton = createDateButton(midDate, coincidence.planeta, 'Medio');
                        
                        const endButton = createDateButton(endDate, coincidence.planeta, 'Fin');
                        
                        buttonsDiv.appendChild(startButton);
                        buttonsDiv.appendChild(midButton);
                        buttonsDiv.appendChild(endButton);
                    }
                    
                    coincidenceItem.appendChild(infoDiv);
                    coincidenceItem.appendChild(buttonsDiv);
                    yearContent.appendChild(coincidenceItem);
                });
                
                yearContainer.appendChild(yearHeader);
                yearContainer.appendChild(yearContent);
                coincidencesListContainer.appendChild(yearContainer);
            });
        }

        function createDateButton(date, planet, label) {
            const formattedDate = date.toISOString().split('T')[0];
            
            const button = document.createElement('button');
            button.className = 'btn btn-sm btn-coincidence';
            button.style.backgroundColor = getColorForPlanet(planet);
            button.style.color = 'white';
            button.textContent = label;
            button.title = `Ver tránsitos para ${date.toLocaleDateString()}`;
            
            button.addEventListener('click', () => {
                loadTransitForDate(formattedDate);
            });
            
            return button;
        }

        // Utilidades
        function createSvgElement(tag, attributes = {}) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
            
            for (const [attr, value] of Object.entries(attributes)) {
                element.setAttribute(attr, value);
            }
            
            return element;
        }

        function createArcPath(startAngle, endAngle) {
            const start = ((startAngle - 90) * Math.PI) / 180;
            const end = ((endAngle - 90) * Math.PI) / 180;
            
            const x1 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(start);
            const y1 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(start);
            const x2 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(end);
            const y2 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(end);
            
            const x1Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(start);
            const y1Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(start);
            const x2Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(end);
            const y2Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(end);
            
            const largeArcFlag = end - start <= Math.PI ? "0" : "1";
            
            return `M ${x1} ${y1} A ${DIMENSIONS.radius} ${DIMENSIONS.radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${DIMENSIONS.innerRadius} ${DIMENSIONS.innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
        }

        function adjustPlanetPosition(planet, allPlanets, isNatal) {
            const angleThreshold = 7; // grados
            
            // Buscar planetas cercanos
            const nearbyPlanets = allPlanets.filter(p => {
                if (p.name === planet.name) return false;
                
                // Calcular diferencia angular
                let diff = Math.abs(p.longitude - planet.longitude);
                if (diff > 180) diff = 360 - diff;
                
                return diff < angleThreshold;
            });
            
            // Si no hay planetas cercanos, no ajustar
            if (nearbyPlanets.length === 0) {
                return {
                    angleOffset: 0
                };
            }
            
            // Determinar dirección del ajuste
            const isLower = planet.name < nearbyPlanets[0].name;
            const angleOffset = isLower ? -3 : 3;
            
            return {
                angleOffset: angleOffset
            };
        }

        function getPlanetColor(planet, longitude) {
            if (planet === 'ASC' || planet === 'MC' || planet === 'DSC' || planet === 'IC') return '#000000';
            
            if (planet === 'JÚPITER') {
                if ((longitude >= 306.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00)) 
                    return COLORS.BLUE;
                if (longitude > 150.00 && longitude < 306.00) 
                    return COLORS.RED;
            }

            if (planet === 'SATURNO') {
                if ((longitude >= 330.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00))
                    return COLORS.YELLOW;
                if (longitude > 240.00 && longitude <= 252.00) return COLORS.YELLOW;
                if (longitude > 252.00 && longitude <= 330.00) return COLORS.RED;
                if (longitude > 150.00 && longitude <= 240.00) return COLORS.RED;
                return COLORS.YELLOW;
            }

            if (longitude > 150.00 && longitude <= 330.00) {
                switch(planet) {
                    case 'SOL': case 'MERCURIO': case 'URANO': return COLORS.GREEN;
                    case 'VENUS': case 'LUNA': return COLORS.YELLOW;
                    case 'MARTE': case 'PLUTÓN': return COLORS.BLUE;
                    case 'NEPTUNO': return COLORS.RED;
                    default: return '#000000';
                }
            } else {
                switch(planet) {
                    case 'SOL': case 'MARTE': case 'PLUTÓN': return COLORS.RED;
                    case 'VENUS': return COLORS.GREEN;
                    case 'MERCURIO': case 'SATURNO': case 'URANO': return COLORS.YELLOW;
                    case 'LUNA': case 'NEPTUNO': return COLORS.BLUE;
                    default: return '#000000';
                }
            }
        }

        function getColorForPlanet(planet) {
            const colors = {
                'SOL': '#FF4500',
                'LUNA': '#6495ED',
                'MERCURIO': '#9370DB',
                'VENUS': '#3CB371',
                'MARTE': '#DC143C',
                'JÚPITER': '#4682B4',
                'SATURNO': '#8B4513'
            };
            
            return colors[planet] || '#007bff';
        }

        function selectPlanet(planetName, isNatal) {
            if (selectedPlanet && selectedPlanet.name === planetName && selectedPlanet.isNatal === isNatal) {
                // Deseleccionar si ya estaba seleccionado
                selectedPlanet = null;
            } else {
                // Seleccionar nuevo planeta
                selectedPlanet = { name: planetName, isNatal };
                selectedAspect = null;
            }
            
            // Actualizar visualización
            updatePlanetsList();
            updateChart();
        }

        function selectAspect(aspect) {
            if (selectedAspect === aspect) {
                // Deseleccionar si ya estaba seleccionado
                selectedAspect = null;
            } else {
                // Seleccionar nuevo aspecto
                selectedAspect = aspect;
                selectedPlanet = null;
            }
            
            // Actualizar visualización
            updateAspectsList();
            updatePlanetsList();
            updateChart();
        }

        function showTooltip(event, text) {
            tooltip.textContent = text;
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY + 10) + 'px';
        }

        function hideTooltip() {
            tooltip.style.display = 'none';
        }

        // Función utilitaria para debounce
        function debounce(func, wait) {
            let timeout;
            return function() {
                const context = this;
                const args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    func.apply(context, args);
                }, wait);
            };
        }
    });
    </script>
</body>
</html>