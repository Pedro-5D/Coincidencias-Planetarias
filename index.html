<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carta Astral Responsive</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 15px;
            background-color: #f0f0f0;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
        }

        /* Estilo para el switch toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #2196F3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Contenedor principal de la carta astral */
        .chart-container {
            position: relative;
            width: 100%;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            overflow: hidden;
        }

        /* Asegurando que el SVG mantenga la proporción adecuada */
        .chart-container::before {
            content: "";
            display: block;
            padding-top: 100%; /* Proporción 1:1 */
        }

        .chart-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Panel de información */
        .info-panel {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        .selected-info {
            padding: 10px;
            background-color: #e6f7ff;
            border-radius: 5px;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        /* Mejoras para móviles */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .chart-container {
                margin-bottom: 10px;
            }
            
            .info-panel {
                max-height: 150px;
            }
        }

        /* Estilos para controles de entrada de datos */
        .input-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 20px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn:hover {
            background-color: #0b7dda;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Carta Astral</h1>
        
        <!-- Controles de entrada de datos -->
        <div class="input-container">
            <h2>Datos de Nacimiento</h2>
            <div class="form-group">
                <div class="input-group">
                    <label for="city">Ciudad:</label>
                    <input type="text" id="city" placeholder="Madrid, España">
                </div>
                <div class="input-group">
                    <label for="date">Fecha:</label>
                    <input type="date" id="date">
                </div>
                <div class="input-group">
                    <label for="time">Hora:</label>
                    <input type="time" id="time">
                </div>
            </div>
            
            <div class="toggle-container" style="margin-bottom: 15px;">
                <label class="switch">
                    <input type="checkbox" id="show-transits" checked>
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 10px;">Mostrar Tránsitos</span>
            </div>
            
            <div id="transit-controls">
                <h3>Datos de Tránsito</h3>
                <div class="form-group">
                    <div class="input-group">
                        <label for="transit-city">Ciudad:</label>
                        <input type="text" id="transit-city" placeholder="Madrid, España">
                    </div>
                    <div class="input-group">
                        <label for="transit-date">Fecha:</label>
                        <input type="date" id="transit-date">
                    </div>
                    <div class="input-group">
                        <label for="transit-time">Hora:</label>
                        <input type="time" id="transit-time">
                    </div>
                </div>
            </div>
            
            <button id="calculate-btn" class="btn">Calcular Carta</button>
        </div>
        
        <header>
            <h2>Visualización de Carta</h2>
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="toggle-transits" checked>
                    <span class="slider"></span>
                </label>
                <span style="margin-left: 10px;">Tránsitos</span>
            </div>
        </header>
        
        <div class="chart-container">
            <svg id="chart" class="chart-svg" viewBox="0 0 600 600" preserveAspectRatio="xMidYMid meet">
                <!-- El contenido SVG se generará dinámicamente mediante JavaScript -->
            </svg>
            <div id="tooltip" class="tooltip"></div>
        </div>
        
        <div class="info-panel">
            <div class="info-header">
                <h3>Información</h3>
                <span id="info-toggle" style="cursor: pointer;">▼</span>
            </div>
            <div id="info-content">
                <div id="selected-info" class="selected-info">
                    Selecciona un planeta o aspecto para ver detalles
                </div>
            </div>
        </div>
    </div>

    <script>
        // Constantes
        const DIMENSIONS = {
            centerX: 300,
            centerY: 300,
            radius: 280,         // Aumentado para maximizar el espacio
            innerRadius: 120,    // Ajustado para mejorar el espacio entre los elementos
            glyphRadius: 265     // Ajustado para posicionar los símbolos del zodiaco
        };

        const SIGNS = [
            {name: 'ARIES', start: 354, length: 36, symbol: '♈', color: '#FFE5E5'},
            {name: 'TAURUS', start: 30, length: 30, symbol: '♉', color: '#E5FFE5'},
            {name: 'GEMINI', start: 60, length: 30, symbol: '♊', color: '#FFFFE5'},
            {name: 'CANCER', start: 90, length: 30, symbol: '♋', color: '#E5FFFF'},
            {name: 'LEO', start: 120, length: 30, symbol: '♌', color: '#FFE5E5'},
            {name: 'VIRGO', start: 150, length: 36, symbol: '♍', color: '#E5FFE5'},
            {name: 'LIBRA', start: 186, length: 24, symbol: '♎', color: '#FFFFE5'},
            {name: 'SCORPIO', start: 210, length: 30, symbol: '♏', color: '#E5FFFF'},
            {name: 'OPHIUCHUS', start: 240, length: 12, symbol: '⛎', color: '#FFFFE5'},
            {name: 'SAGITTARIUS', start: 252, length: 18, symbol: '♐', color: '#FFE5E5'},
            {name: 'CAPRICORN', start: 270, length: 36, symbol: '♑', color: '#E5FFE5'},
            {name: 'AQUARIUS', start: 306, length: 18, symbol: '♒', color: '#FFFFE5'},
            {name: 'PEGASUS', start: 324, length: 6, symbol: '∩', color: '#E5FFFF'},
            {name: 'PISCES', start: 330, length: 24, symbol: '♓', color: '#E5FFFF'}
        ];

        const PLANET_SYMBOLS = {
            'SOL': '☉',
            'LUNA': '☽',
            'MERCURIO': '☿',
            'VENUS': '♀',
            'MARTE': '♂',
            'JÚPITER': '♃',
            'SATURNO': '♄',
            'URANO': '♅',
            'NEPTUNO': '♆',
            'PLUTÓN': '♇',
            'ASC': 'ASC',
            'MC': 'MC',
            'DSC': 'DSC',
            'IC': 'IC'
        };

        const ASPECTS = {
            CONJUNCTION: { angle: 0, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            SEXTILE: { angle: 60, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            SQUARE: { angle: 90, orb: 2, color: '#FF0000', name: 'Inarmónico Relevante' },
            TRINE: { angle: 120, orb: 2, color: '#000080', name: 'Armónico Relevante' },
            OPPOSITION: { angle: 180, orb: 2, color: '#000080', name: 'Armónico Relevante' }
        };

        const COLORS = {
            RED: '#FF0000',
            GREEN: '#00FF00',
            BLUE: '#0000FF',
            YELLOW: '#FFFF00'
        };

        // Estado global
        let natalPlanets = [];
        let transitPlanets = [];
        let internalAspects = [];
        let interChartAspects = [];
        let showTransits = true;
        let selectedPlanet = null;
        let selectedAspect = null;
        
        // Referencias a elementos DOM
        const chartSvg = document.getElementById('chart');
        const tooltipEl = document.getElementById('tooltip');
        const toggleTransitsCheckbox = document.getElementById('toggle-transits');
        const showTransitsCheckbox = document.getElementById('show-transits');
        const transitControlsDiv = document.getElementById('transit-controls');
        const selectedInfoEl = document.getElementById('selected-info');
        const infoToggleEl = document.getElementById('info-toggle');
        const infoContentEl = document.getElementById('info-content');

        // Establecer fechas actuales por defecto
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        const timeStr = today.toTimeString().slice(0, 5);
        
        document.getElementById('date').value = dateStr;
        document.getElementById('time').value = timeStr;
        document.getElementById('transit-date').value = dateStr;
        document.getElementById('transit-time').value = timeStr;

        // Event listeners
        toggleTransitsCheckbox.addEventListener('change', function() {
            showTransits = this.checked;
            renderChart();
        });
        
        showTransitsCheckbox.addEventListener('change', function() {
            transitControlsDiv.style.display = this.checked ? 'block' : 'none';
        });
        
        document.getElementById('calculate-btn').addEventListener('click', calculateChart);
        
        infoToggleEl.addEventListener('click', function() {
            if (infoContentEl.style.display === 'none') {
                infoContentEl.style.display = 'block';
                infoToggleEl.textContent = '▼';
            } else {
                infoContentEl.style.display = 'none';
                infoToggleEl.textContent = '▶';
            }
        });

        // Simulación de datos de planetas
        function mockCalculatePositions(isNatal) {
            const basePositions = [
                { name: "SOL", longitude: isNatal ? 120 : 150, sign: isNatal ? "LEO" : "VIRGO" },
                { name: "LUNA", longitude: isNatal ? 186 : 210, sign: isNatal ? "LIBRA" : "SCORPIO" },
                { name: "MERCURIO", longitude: isNatal ? 135 : 145, sign: isNatal ? "LEO" : "VIRGO" },
                { name: "VENUS", longitude: isNatal ? 90 : 100, sign: isNatal ? "CANCER" : "CANCER" },
                { name: "MARTE", longitude: isNatal ? 210 : 240, sign: isNatal ? "SCORPIO" : "OPHIUCHUS" },
                { name: "JÚPITER", longitude: isNatal ? 270 : 290, sign: isNatal ? "CAPRICORN" : "CAPRICORN" },
                { name: "SATURNO", longitude: isNatal ? 330 : 350, sign: isNatal ? "PISCES" : "PISCES" },
                { name: "URANO", longitude: isNatal ? 30 : 32, sign: isNatal ? "TAURUS" : "TAURUS" },
                { name: "NEPTUNO", longitude: isNatal ? 354 : 355, sign: isNatal ? "ARIES" : "ARIES" },
                { name: "PLUTÓN", longitude: isNatal ? 252 : 254, sign: isNatal ? "SAGITTARIUS" : "SAGITTARIUS" },
                { name: "ASC", longitude: isNatal ? 0 : 10, sign: isNatal ? "ARIES" : "ARIES" },
                { name: "MC", longitude: isNatal ? 270 : 280, sign: isNatal ? "CAPRICORN" : "CAPRICORN" }
            ];

            // Añadir variación a las posiciones para la segunda carta
            if (!isNatal) {
                return basePositions.map(planet => ({
                    ...planet,
                    longitude: (planet.longitude + Math.random() * 20 - 10) % 360
                }));
            }

            return basePositions;
        }

        // Calcular la carta
        function calculateChart() {
            // En una aplicación real, aquí harías peticiones a un servidor
            // Para este ejemplo, usamos datos simulados
            natalPlanets = mockCalculatePositions(true);
            transitPlanets = mockCalculatePositions(false);
            
            // Calcular aspectos
            internalAspects = calculateAspects(natalPlanets);
            interChartAspects = calculateAspects(natalPlanets, transitPlanets);
            
            // Renderizar la carta
            renderChart();
        }

        // Función para calcular aspectos entre planetas
        function calculateAspects(planets1, planets2 = null) {
            const aspects = [];
            
            // Si solo pasamos un conjunto de planetas, calculamos aspectos internos
            if (!planets2) {
                planets2 = planets1;
            }
            
            // Filtramos planetas para incluir solo los tradicionales
            const validPlanets1 = planets1.filter(p => 
                ["SOL", "LUNA", "MERCURIO", "VENUS", "MARTE", "JÚPITER", "SATURNO"].includes(p.name)
            );
            
            const validPlanets2 = planets2.filter(p => 
                ["SOL", "LUNA", "MERCURIO", "VENUS", "MARTE", "JÚPITER", "SATURNO"].includes(p.name)
            );

            // Si estamos calculando aspectos entre dos cartas diferentes, usamos todos los planetas
            // Si estamos calculando aspectos dentro de la misma carta, evitamos duplicados
            for (let i = 0; i < validPlanets1.length; i++) {
                const startJ = planets1 === planets2 ? i + 1 : 0;
                for (let j = startJ; j < validPlanets2.length; j++) {
                    const planet1 = validPlanets1[i];
                    const planet2 = validPlanets2[j];
                    
                    // Evitar comparar un planeta consigo mismo
                    if (planet1 === planet2) continue;
                    
                    let diff = Math.abs(planet1.longitude - planet2.longitude);
                    if (diff > 180) diff = 360 - diff;
                    
                    for (const aspectType in ASPECTS) {
                        const aspect = ASPECTS[aspectType];
                        if (Math.abs(diff - aspect.angle) <= aspect.orb) {
                            aspects.push({
                                planet1: planet1.name,
                                planet2: planet2.name,
                                type: aspectType,
                                angle: diff,
                                color: aspect.color,
                                isInterChart: planets1 !== planets2
                            });
                            break;
                        }
                    }
                }
            }
            return aspects;
        }

        // Función para renderizar la carta
        function renderChart() {
            // Limpiar SVG
            chartSvg.innerHTML = '';
            
            // Dibujar círculo exterior
            createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.radius,
                fill: 'none',
                stroke: '#333',
                'stroke-width': 2
            }, chartSvg);
            
            // Dibujar signos zodiacales
            SIGNS.forEach(sign => {
                const midAngle = ((sign.start + sign.length/2 - 90) * Math.PI) / 180;
                const glyphX = DIMENSIONS.centerX + DIMENSIONS.glyphRadius * Math.cos(midAngle);
                const glyphY = DIMENSIONS.centerY + DIMENSIONS.glyphRadius * Math.sin(midAngle);
                
                // Dibujar sector
                const path = createSvgElement('path', {
                    d: createArcPath(sign.start, sign.start + sign.length),
                    fill: sign.color,
                    stroke: '#333',
                    'stroke-width': 1
                }, chartSvg);
                
                // Añadir símbolo
                const text = createSvgElement('text', {
                    x: glyphX,
                    y: glyphY,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'middle',
                    'font-size': 20
                }, chartSvg);
                text.textContent = sign.symbol;
            });
            
            // Dibujar círculo interior
            createSvgElement('circle', {
                cx: DIMENSIONS.centerX,
                cy: DIMENSIONS.centerY,
                r: DIMENSIONS.innerRadius,
                fill: 'white',
                stroke: '#333',
                'stroke-width': 1
            }, chartSvg);
            
            // Dibujar aspectos
            const aspectsToDisplay = [
                ...internalAspects,
                ...(showTransits ? interChartAspects : [])
            ];
            
            aspectsToDisplay.forEach((aspect, index) => {
                // Determinar los planetas y sus posiciones
                const planet1Source = aspect.isInterChart ? natalPlanets : natalPlanets;
                const planet2Source = aspect.isInterChart ? transitPlanets : natalPlanets;
                
                const planet1 = planet1Source.find(p => p.name === aspect.planet1);
                const planet2 = planet2Source.find(p => p.name === aspect.planet2);
                
                if (!planet1 || !planet2) return;
                
                const angle1 = (planet1.longitude - 90) * Math.PI / 180;
                const angle2 = (planet2.longitude - 90) * Math.PI / 180;
                
                const radius = DIMENSIONS.innerRadius;
                // Para planetas de tránsito, usamos un radio ligeramente mayor al renderizar
                const radius2 = aspect.isInterChart ? DIMENSIONS.innerRadius + 60 : radius;
                
                const x1 = DIMENSIONS.centerX + radius * Math.cos(angle1);
                const y1 = DIMENSIONS.centerY + radius * Math.sin(angle1);
                const x2 = DIMENSIONS.centerX + radius2 * Math.cos(angle2);
                const y2 = DIMENSIONS.centerY + radius2 * Math.sin(angle2);
                
                const line = createSvgElement('line', {
                    x1: x1,
                    y1: y1,
                    x2: x2,
                    y2: y2,
                    stroke: aspect.color,
                    'stroke-width': selectedAspect === aspect ? "3" : "1",
                    'stroke-dasharray': aspect.isInterChart ? "3,3" : "none",
                    'class': 'aspect-line',
                    'data-aspect-index': index
                }, chartSvg);
                
                line.addEventListener('click', () => {
                    selectAspect(aspect);
                });
                
                line.addEventListener('mouseover', (e) => {
                    const aspectName = ASPECTS[aspect.type]?.name || aspect.type;
                    showTooltip(`${aspect.planet1} ${aspectName} ${aspect.planet2} (${aspect.angle.toFixed(2)}°)`, e);
                });
                
                line.addEventListener('mouseout', hideTooltip);
            });
            
            // Dibujar planetas natales
            natalPlanets.forEach((planet) => {
                const adjustment = adjustPlanetLabel(planet, natalPlanets, DIMENSIONS.innerRadius - 20);
                const adjustedAngle = ((planet.longitude + adjustment.angleOffset - 90) * Math.PI) / 180;
                const x = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(adjustedAngle);
                const y = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(adjustedAngle);
                
                const labelX = DIMENSIONS.centerX + adjustment.radius * Math.cos(adjustedAngle);
                const labelY = DIMENSIONS.centerY + adjustment.radius * Math.sin(adjustedAngle);
                
                const isSelected = selectedPlanet && 
                                    selectedPlanet.name === planet.name && 
                                    selectedPlanet.isNatal;
                
                const color = getPlanetColor(planet.name, planet.longitude);
                
                // Dibujar círculo del planeta
                const circle = createSvgElement('circle', {
                    cx: x,
                    cy: y,
                    r: isSelected ? "8" : "6",
                    fill: color,
                    stroke: '#000',
                    'stroke-width': isSelected ? "2" : "1",
                    'class': 'planet-circle',
                    'data-planet': planet.name,
                    'data-is-natal': 'true'
                }, chartSvg);
                
                // Dibujar símbolo del planeta
                const text = createSvgElement('text', {
                    x: labelX,
                    y: labelY,
                    'text-anchor': 'middle',
                    'dominant-baseline': 'middle',
                    'font-size': isSelected ? "18" : "16",
                    'font-weight': 'bold',
                    'fill': '#111',
                    'class': 'planet-symbol',
                    'data-planet': planet.name,
                    'data-is-natal': 'true'
                }, chartSvg);
                text.textContent = PLANET_SYMBOLS[planet.name] || planet.name;
                
                // Añadir eventos
                [circle, text].forEach(element => {
                    element.addEventListener('click', () => {
                        selectPlanet(planet.name, true);
                    });
                    
                    element.addEventListener('mouseover', (e) => {
                        showTooltip(`${planet.name}: ${planet.longitude.toFixed(2)}° ${planet.sign}`, e);
                    });
                    
                    element.addEventListener('mouseout', hideTooltip);
                });
            });
            
            // Dibujar planetas de tránsito
            if (showTransits && transitPlanets.length > 0) {
                transitPlanets.forEach((planet) => {
                    const transitRadius = DIMENSIONS.innerRadius + 60;
                    
                    const adjustment = adjustPlanetLabel(planet, transitPlanets, transitRadius + 20);
                    const adjustedAngle = ((planet.longitude + adjustment.angleOffset - 90) * Math.PI) / 180;
                    
                    const x = DIMENSIONS.centerX + transitRadius * Math.cos(adjustedAngle);
                    const y = DIMENSIONS.centerY + transitRadius * Math.sin(adjustedAngle);
                    
                    const labelX = DIMENSIONS.centerX + (transitRadius + 20) * Math.cos(adjustedAngle);
                    const labelY = DIMENSIONS.centerY + (transitRadius + 20) * Math.sin(adjustedAngle);
                    
                    const isSelected = selectedPlanet && 
                                        selectedPlanet.name === planet.name && 
                                        !selectedPlanet.isNatal;
                    
                    const color = getPlanetColor(planet.name, planet.longitude);
                    
                    // Dibujar círculo del planeta
                    const circle = createSvgElement('circle', {
                        cx: x,
                        cy: y,
                        r: isSelected ? "8" : "6",
                        fill: color,
                        stroke: '#000',
                        'stroke-width': isSelected ? "2" : "1",
                        'class': 'planet-circle',
                        'data-planet': planet.name,
                        'data-is-natal': 'false'
                    }, chartSvg);
                    
                    // Dibujar símbolo del planeta
                    const text = createSvgElement('text', {
                        x: labelX,
                        y: labelY,
                        'text-anchor': 'middle',
                        'dominant-baseline': 'middle',
                        'font-size': isSelected ? "18" : "16",
                        'font-weight': 'bold',
                        'fill': '#555',
                        'class': 'planet-symbol',
                        'data-planet': planet.name,
                        'data-is-natal': 'false'
                    }, chartSvg);
                    text.textContent = PLANET_SYMBOLS[planet.name] || planet.name;
                    
                    // Añadir eventos
                    [circle, text].forEach(element => {
                        element.addEventListener('click', () => {
                            selectPlanet(planet.name, false);
                        });
                        
                        element.addEventListener('mouseover', (e) => {
                            showTooltip(`${planet.name} (Tránsito): ${planet.longitude.toFixed(2)}° ${planet.sign}`, e);
                        });
                        
                        element.addEventListener('mouseout', hideTooltip);
                    });
                });
            }
            
            // Actualizar panel de información
            updateInfoPanel();
        }

        // Función para actualizar el panel de información
        function updateInfoPanel() {
            if (selectedPlanet) {
                const planetSource = selectedPlanet.isNatal ? natalPlanets : transitPlanets;
                const planet = planetSource.find(p => p.name === selectedPlanet.name);
                
                if (planet) {
                    selectedInfoEl.innerHTML = `
                        <h4 class="font-bold">${planet.name} ${!selectedPlanet.isNatal ? '(Tránsito)' : ''}</h4>
                        <div>${planet.longitude.toFixed(2)}° ${planet.sign}</div>
                    `;
                }
            } else if (selectedAspect) {
                const aspectName = ASPECTS[selectedAspect.type]?.name || selectedAspect.type;
                selectedInfoEl.innerHTML = `
                    <div class="font-bold">
                        ${selectedAspect.planet1} ${aspectName} ${selectedAspect.planet2}
                    </div>
                    <div>${selectedAspect.angle.toFixed(2)}°</div>
                `;
            } else {
                selectedInfoEl.textContent = 'Selecciona un planeta o aspecto para ver detalles';
            }
        }

        // Funciones para selección
        function selectPlanet(planetName, isNatal) {
            if (selectedPlanet && selectedPlanet.name === planetName && selectedPlanet.isNatal === isNatal) {
                selectedPlanet = null;
            } else {
                selectedPlanet = { name: planetName, isNatal };
                selectedAspect = null;
            }
            
            renderChart();
        }

        function selectAspect(aspect) {
            if (selectedAspect === aspect) {
                selectedAspect = null;
            } else {
                selectedAspect = aspect;
                selectedPlanet = null;
            }
            
            renderChart();
        }

        // Funciones para tooltip
        function showTooltip(text, event) {
            tooltipEl.textContent = text;
            tooltipEl.style.display = 'block';
            
            const rect = chartSvg.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            
            tooltipEl.style.left = (x + 10) + 'px';
            tooltipEl.style.top = (y + 10) + 'px';
        }

        function hideTooltip() {
            tooltipEl.style.display = 'none';
        }

        // Funciones auxiliares
        function createSvgElement(tag, attributes = {}, parent = null) {
            const element = document.createElementNS('http://www.w3.org/2000/svg', tag);
            
            for (const [attr, value] of Object.entries(attributes)) {
                element.setAttribute(attr, value);
            }
            
            if (parent) {
                parent.appendChild(element);
            }
            
            return element;
        }

        function createArcPath(startAngle, endAngle) {
            const start = ((startAngle - 90) * Math.PI) / 180;
            const end = ((endAngle - 90) * Math.PI) / 180;
            
            const x1 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(start);
            const y1 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(start);
            const x2 = DIMENSIONS.centerX + DIMENSIONS.radius * Math.cos(end);
            const y2 = DIMENSIONS.centerY + DIMENSIONS.radius * Math.sin(end);
            
            const x1Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(start);
            const y1Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(start);
            const x2Inner = DIMENSIONS.centerX + DIMENSIONS.innerRadius * Math.cos(end);
            const y2Inner = DIMENSIONS.centerY + DIMENSIONS.innerRadius * Math.sin(end);
            
            const largeArcFlag = end - start <= Math.PI ? "0" : "1";
            
            return `M ${x1} ${y1} A ${DIMENSIONS.radius} ${DIMENSIONS.radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x2Inner} ${y2Inner} A ${DIMENSIONS.innerRadius} ${DIMENSIONS.innerRadius} 0 ${largeArcFlag} 0 ${x1Inner} ${y1Inner} Z`;
        }

        function adjustPlanetLabel(planet, allPlanets, radius) {
            const angleDiff = 7;
            
            const nearbyPlanets = allPlanets.filter(p => {
                if (p.name === planet.name) return false;
                let diff = Math.abs(p.longitude - planet.longitude);
                if (diff > 180) diff = 360 - diff;
                return diff < angleDiff;
            });
            
            if (nearbyPlanets.length === 0) {
                return {
                    radius: radius,
                    angleOffset: 0
                };
            }
            
            const isLower = planet.name < nearbyPlanets[0].name;
            const radiusOffset = isLower ? 0 : 15;
            const angleOffset = isLower ? -1 : 1;
            
            return {
                radius: radius + radiusOffset,
                angleOffset: angleOffset * 3
            };
        }

        function getPlanetColor(planet, longitude) {
            if (planet === 'ASC' || planet === 'MC' || planet === 'DSC' || planet === 'IC') return '#000000';
            
            if (planet === 'JÚPITER') {
                if ((longitude >= 306.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00)) 
                    return COLORS.BLUE;
                if (longitude > 150.00 && longitude < 306.00) 
                    return COLORS.RED;
            }

            if (planet === 'SATURNO') {
                if ((longitude >= 330.00 && longitude <= 360.00) || (longitude >= 0.00 && longitude <= 150.00))
                    return COLORS.YELLOW;
                if (longitude > 240.00 && longitude <= 252.00) return COLORS.YELLOW;
                if (longitude > 252.00 && longitude <= 330.00) return COLORS.RED;
                if (longitude > 150.00 && longitude <= 240.00) return COLORS.RED;
                return COLORS.YELLOW;
            }

            if (longitude > 150.00 && longitude <= 330.00) {
                switch(planet) {
                    case 'SOL': case 'MERCURIO': case 'URANO': return COLORS.GREEN;
                    case 'VENUS': case 'LUNA': return COLORS.YELLOW;
                    case 'MARTE': case 'PLUTÓN': return COLORS.BLUE;
                    case 'NEPTUNO': return COLORS.RED;
                    default: return '#000000';
                }
            } else {
                switch(planet) {
                    case 'SOL': case 'MARTE': case 'PLUTÓN': return COLORS.RED;
                    case 'VENUS': return COLORS.GREEN;
                    case 'MERCURIO': case 'SATURNO': case 'URANO': return COLORS.YELLOW;
                    case 'LUNA': case 'NEPTUNO': return COLORS.BLUE;
                    default: return '#000000';
                }
            }
        }

        // Iniciar la aplicación con datos de ejemplo
        calculateChart();
    </script>
</body>
</html>
